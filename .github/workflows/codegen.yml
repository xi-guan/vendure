name: Codegen

on:
    workflow_call:
        secrets:
            NX_CLOUD_ACCESS_TOKEN:
                required: false
                description: 'Nx Cloud access token for caching'

env:
    CI: true
    NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}

jobs:
    codegen:
        runs-on: ubuntu-latest
        permissions:
            contents: read
        steps:
            - uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 10

            - name: Use Node.js 22
              uses: actions/setup-node@v4
              with:
                  node-version: 22
                  cache: 'pnpm'

            - name: Get pnpm store directory
              id: pnpm-cache
              shell: bash
              run: echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

            - name: Setup pnpm cache
              uses: actions/cache@v4
              with:
                  path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
                  key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
                  restore-keys: |
                      ${{ runner.os }}-pnpm-store-

            - name: Cache Nx
              uses: actions/cache@v4
              with:
                  path: .nx/cache
                  key: ${{ runner.os }}-nx-codegen-${{ hashFiles('pnpm-lock.yaml') }}-${{ github.sha }}
                  restore-keys: |
                      ${{ runner.os }}-nx-codegen-${{ hashFiles('pnpm-lock.yaml') }}-
                      ${{ runner.os }}-nx-codegen-

            - name: Install dependencies
              run: pnpm install --frozen-lockfile --config.ignore-scripts=false

            - name: Build bcrypt native module
              run: |
                  cd node_modules/.pnpm/bcrypt@*/node_modules/bcrypt
                  npm run install
                  cd -

            - name: Build core and common packages
              run: |
                  pnpm nx build @vendure/common
                  pnpm nx build @vendure/core

            - name: Generate GraphQL types
              run: pnpm run codegen
